# MÃ³dulo 3 - Library Service ğŸ“š

ServiÃ§o responsÃ¡vel por gerenciar **Playlists e Favoritos** com tratamento de integridade distribuÃ­da.

## ğŸ¯ CaracterÃ­sticas Principais

- ğŸ“ **Gerenciamento de Playlists**: Criar, listar, atualizar e deletar
- ğŸµ **VinculaÃ§Ã£o de MÃºsicas**: Adicionar/remover mÃºsicas por ID
- ğŸ”— **IntegraÃ§Ã£o com MÃ³dulo 4**: Busca detalhes das mÃºsicas no Metadata Service
- ğŸ›¡ï¸ **Tratamento de Falhas**: Continua funcionando mesmo se MÃ³dulo 4 estiver offline
- ğŸ¯ **Diferencial SD**: Integridade graceful - lista mÃºsicas mesmo sem detalhes completos

## ğŸš€ InstalaÃ§Ã£o

```bash
cd modulo3_biblioteca
npm install
```

## â–¶ï¸ ExecuÃ§Ã£o

```bash
npm start
```

O servidor estarÃ¡ disponÃ­vel em `http://localhost:3003`

## ğŸ“¡ Rotas DisponÃ­veis

### Playlists

| MÃ©todo | Rota | DescriÃ§Ã£o |
|--------|------|-----------|
| POST | `/playlist/criar` | Cria uma nova playlist |
| GET | `/playlist/usuario/:usuarioId` | Lista playlists de um usuÃ¡rio |
| GET | `/playlist/list/:usuarioId` | Alias para listar playlists |
| GET | `/playlist/:playlistId` | ObtÃ©m playlist com detalhes das mÃºsicas |
| POST | `/playlist/add` | Adiciona mÃºsica a uma playlist |
| POST | `/playlist/remover` | Remove mÃºsica de uma playlist |
| PUT | `/playlist/:playlistId` | Atualiza nome/descriÃ§Ã£o da playlist |
| DELETE | `/playlist/:playlistId` | Deleta uma playlist |

### Status

| MÃ©todo | Rota | DescriÃ§Ã£o |
|--------|------|-----------|
| GET | `/health` | Health check do serviÃ§o |

## ğŸ“ Exemplos de Uso

### Criar uma playlist

```bash
curl -X POST http://localhost:3003/playlist/criar \
  -H "Content-Type: application/json" \
  -d '{
    "usuarioId": "user-123",
    "nome": "Minhas MÃºsicas Favoritas",
    "descricao": "Playlist com meus artistas preferidos"
  }'
```

**PowerShell:**
```powershell
$body = ConvertTo-Json @{
  usuarioId = "user-123"
  nome = "Minhas Favoritas"
  descricao = "As melhores mÃºsicas"
}
Invoke-WebRequest -Uri "http://localhost:3003/playlist/criar" -Method Post -ContentType "application/json" -Body $body
```

### Adicionar mÃºsica Ã  playlist

```bash
curl -X POST http://localhost:3003/playlist/add \
  -H "Content-Type: application/json" \
  -d '{
    "playlistId": "playlist-uuid-aqui",
    "musicaId": "musica-uuid-aqui"
  }'
```

**PowerShell:**
```powershell
$body = ConvertTo-Json @{
  playlistId = "playlist-uuid-aqui"
  musicaId = "musica-uuid-aqui"
}
Invoke-WebRequest -Uri "http://localhost:3003/playlist/add" -Method Post -ContentType "application/json" -Body $body
```

### Listar playlists de um usuÃ¡rio

```bash
curl http://localhost:3003/playlist/usuario/user-123
```

**PowerShell:**
```powershell
Invoke-WebRequest -Uri "http://localhost:3003/playlist/usuario/user-123"
```

### Obter playlist com detalhes

```bash
curl http://localhost:3003/playlist/playlist-uuid-aqui
```

**PowerShell:**
```powershell
$response = Invoke-WebRequest -Uri "http://localhost:3003/playlist/playlist-uuid-aqui"
$response.Content | ConvertFrom-Json
```

## ğŸ“Š Formato de Resposta

Todas as respostas seguem o formato padronizado:

### Sucesso
```json
{
  "sucesso": true,
  "mensagem": "Playlist criada com sucesso",
  "dados": {
    "id": "901ce5c3-51c9-4a27-aa24-ed221a6813c3",
    "userId": "user-123",
    "nome": "Minhas Favoritas",
    "descricao": "As melhores",
    "musicaIds": [],
    "criadoEm": "2025-12-09T18:00:00.000Z",
    "atualizadoEm": "2025-12-09T18:00:00.000Z"
  },
  "timestamp": "2025-12-09T18:00:00.000Z"
}
```

### Erro
```json
{
  "sucesso": false,
  "mensagem": "Playlist com ID xyz nÃ£o encontrada",
  "erro": "Detalhes do erro",
  "timestamp": "2025-12-09T18:00:00.000Z"
}
```

## ğŸ›¡ï¸ Tratamento de Falhas (Diferencial SD)

Se o **MÃ³dulo 4 (Metadata Service)** estiver offline:

- âœ… Playlists continuam funcionando normalmente
- âœ… MÃºsicas podem ser adicionadas/removidas (armazena apenas IDs)
- âœ… Lista de IDs das mÃºsicas Ã© sempre retornada
- âš ï¸ Detalhes das mÃºsicas aparecem como "IndisponÃ­vel"

### Exemplo de resposta com MÃ³dulo 4 offline:

```json
{
  "id": "playlist-123",
  "nome": "Minhas Favoritas",
  "musicaIds": ["musica-1", "musica-2"],
  "musicas": [
    {
      "id": "musica-1",
      "titulo": "IndisponÃ­vel",
      "artista": "IndisponÃ­vel",
      "capa": null,
      "duracao": 0,
      "aviso": "Detalhes indisponÃ­veis (Metadata Service offline)"
    }
  ]
}
```

## ğŸ—ï¸ Arquitetura

```
modulo3_biblioteca/
â”œâ”€â”€ server.js              # Servidor Express principal
â”œâ”€â”€ playlistController.js  # Endpoints REST
â”œâ”€â”€ playlistService.js     # LÃ³gica de negÃ³cio
â”œâ”€â”€ playlistStorage.js     # PersistÃªncia em JSON
â”œâ”€â”€ metadataClient.js      # Cliente HTTP para MÃ³dulo 4
â”œâ”€â”€ package.json           # DependÃªncias
â”œâ”€â”€ .env                   # ConfiguraÃ§Ãµes
â””â”€â”€ data/
    â””â”€â”€ playlists.json     # Dados persistidos
```

## ğŸ”§ ConfiguraÃ§Ã£o (.env)

```env
PORT=3003
METADATA_SERVICE_URL=http://localhost:3004
NODE_ENV=development
```

## ğŸ“¦ DependÃªncias

- **express**: Framework web
- **cors**: Habilita CORS
- **dotenv**: Gerenciamento de variÃ¡veis de ambiente
- **uuid**: GeraÃ§Ã£o de IDs Ãºnicos
- **axios**: Cliente HTTP para comunicaÃ§Ã£o com MÃ³dulo 4

## ğŸ§ª Testando

### Health Check
```bash
curl http://localhost:3003/health
```

### Fluxo Completo
```bash
# 1. Criar playlist
PLAYLIST=$(curl -s -X POST http://localhost:3003/playlist/criar \
  -H "Content-Type: application/json" \
  -d '{"usuarioId":"user-1","nome":"Test"}' | jq -r '.dados.id')

# 2. Adicionar mÃºsica
curl -X POST http://localhost:3003/playlist/add \
  -H "Content-Type: application/json" \
  -d "{\"playlistId\":\"$PLAYLIST\",\"musicaId\":\"musica-id-aqui\"}"

# 3. Ver playlist com detalhes
curl http://localhost:3003/playlist/$PLAYLIST
```

## ğŸŒ IntegraÃ§Ã£o com MÃ³dulo 4

O serviÃ§o se comunica com o Metadata Service para obter detalhes das mÃºsicas:

- **Timeout**: 5 segundos por requisiÃ§Ã£o
- **Fallback**: Retorna dados parciais se MÃ³dulo 4 falhar
- **ResiliÃªncia**: Usa `Promise.allSettled` para robustez

## ğŸ“Œ Notas Importantes

1. **Armazenamento**: Playlists armazenam apenas IDs de mÃºsicas, nÃ£o dados completos
2. **Desacoplamento**: Funciona independentemente do MÃ³dulo 4
3. **Graceful Degradation**: ServiÃ§o degradado mas funcional em caso de falhas
4. **PersistÃªncia**: Dados salvos em JSON no diretÃ³rio `data/`

---

**Porta**: 3003  
**Status**: âœ… Operacional  
**VersÃ£o**: 1.0.0
