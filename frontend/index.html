<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Minha Biblioteca</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #b3b3b3; font-family: sans-serif; padding-bottom: 100px; }
        .sidebar { height: 100vh; background-color: #000; position: fixed; width: 240px; padding: 20px; }
        .main-content { margin-left: 240px; padding: 20px; }
        .card-music { background-color: #181818; padding: 15px; border-radius: 8px; transition: 0.3s; cursor: pointer; }
        .card-music:hover { background-color: #282828; color: white; }
        .player-bar { position: fixed; bottom: 0; width: 100%; height: 90px; background-color: #181818; border-top: 1px solid #282828; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        .premium-badge { background-color: gold; color: black; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8em; display: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3 class="text-white mb-4">üéµ MusicApp</h3>
    <ul class="list-unstyled">
        <li class="mb-2 text-white">üè† In√≠cio</li>
        <li class="mb-2">üîç Buscar</li>
        <li class="mb-2">üìö Sua Biblioteca</li>
    </ul>
    <hr>
    <div id="user-info">Carregando...</div>
    <span id="premium-tag" class="premium-badge mt-2">PREMIUM üíé</span>
    <button onclick="upgradeAccount()" id="btn-upgrade" class="btn btn-outline-light btn-sm mt-3 w-100">Virar Premium</button>
    <button onclick="logout()" class="btn btn-link text-secondary btn-sm mt-2">Sair</button>
</div>

<div class="main-content">
    <h2 class="text-white mb-3">M√∫sicas para voc√™</h2>
    
    <div class="row" id="music-list">
        </div>
    <h2 class="text-white mb-3 mt-4">Sala</h2>
    <div class="row g-3">
        <div class="col-md-6">
            <div class="p-3" style="background-color:#181818;border-radius:8px;">
                <div class="d-flex gap-2 mb-3">
                    <input type="text" id="room-id" class="form-control form-control-sm" placeholder="ID da Sala" value="sala1" style="max-width:140px;">
                    <button class="btn btn-sm btn-success" onclick="joinSala()">Entrar</button>
                    <button class="btn btn-sm btn-secondary" onclick="leaveSala()">Sair da Sala</button>
                </div>
                <div class="mb-3">
                    <div id="room-status" class="text-secondary">Aguardando...</div>
                    <div id="room-time" class="h3 text-white">00:00</div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" onclick="sendRoomAction('play')">Play</button>
                        <button class="btn btn-sm btn-warning" onclick="sendRoomAction('pause')">Pause</button>
                    </div>
                </div>
                <div class="p-3" style="background-color:#222;border-radius:8px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-white">Pular M√∫sica?</div>
                        <button class="btn btn-sm btn-danger" onclick="sendRoomAction('vote')">Votar para Pular</button>
                    </div>
                    <div id="room-votes" class="mt-2 text-white">Votos: 0/0</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="p-3" style="background-color:#181818;border-radius:8px;">
                <div id="room-chat" class="mb-2" style="height:220px;overflow-y:auto;background-color:#111;border-radius:6px;padding:8px;"></div>
                <div class="d-flex gap-2">
                    <input type="text" id="room-chat-input" class="form-control form-control-sm" placeholder="Digite sua mensagem" onkeypress="roomHandleEnter(event)">
                    <button class="btn btn-sm btn-primary" onclick="sendRoomChat()">Enviar</button>
                </div>
                <div id="room-log" class="mt-3" style="font-family:monospace;font-size:.85em;height:120px;overflow-y:auto;background-color:#111;color:#0f0;border-radius:6px;padding:8px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="player-bar">
    <div style="width: 30%">
        <h6 class="text-white mb-0" id="current-song-title">Nada tocando</h6>
        <small id="current-artist">Escolha uma m√∫sica</small>
    </div>
    <div style="width: 40%" class="text-center">
        <audio id="audio-player" controls style="width: 100%; height: 40px;"></audio>
    </div>
    <div style="width: 30%; text-align: right;">
        Volume üîä
    </div>
</div>

<script>
    // CONFIGURA√á√ÉO DAS PORTAS
    const API = {
        BILLING: "http://localhost:3006/api/assinatura",
        CATALOG: "http://localhost:3004/musicas",
        STREAM: "http://localhost:3002/stream",
        LIBRARY: "http://localhost:3003"
    };

    // 1. Verificar Autentica√ß√£o ao carregar
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');
    const username = localStorage.getItem('username');

    if (!token || !userId) {
        window.location.href = 'login.html';
    }

    document.getElementById('user-info').innerText = `ID: ${userId}`;

    // 2. Carregar Status Premium (Billing Service)
    async function loadUserStatus() {
        try {
            const res = await fetch(`${API.BILLING}/status/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            if (data.premium) {
                document.getElementById('premium-tag').style.display = 'inline-block';
                document.getElementById('btn-upgrade').style.display = 'none';
            }
        } catch (e) {
            console.error("Erro ao carregar billing:", e);
        }
    }

    // 3. Simular Upgrade de Conta
    async function upgradeAccount() {
        if(confirm("Deseja pagar R$ 19,90 para virar Premium?")) {
            await fetch(`${API.BILLING}/upgrade/${userId}`, { 
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            alert("Parab√©ns! Voc√™ agora √© Premium. (Recarregando...)");
            location.reload();
        }
    }

    // 4. Carregar M√∫sicas (Mockado para teste, substitua pela chamada real)
    async function loadSongs() {
        try {
            const res = await fetch(`${API.CATALOG}`);
            const json = await res.json();
            const songs = json.dados || [];
            const container = document.getElementById('music-list');
            container.innerHTML = '';
            songs.forEach(song => {
                const html = `
                    <div class="col-md-4 mb-3">
                        <div class="card-music">
                            <div style="background: #333 url('${song.capa || ''}') center/cover no-repeat; height: 150px; width: 100%; margin-bottom: 10px;"></div>
                            <h5 class="text-white mb-0">${song.titulo}</h5>
                            <small>${song.artista}</small>
                            <div class="mt-2 d-flex gap-2">
                                <button class="btn btn-sm btn-green" onclick="playTrack('${song.id}','${song.titulo}','${song.artista}')">Tocar</button>
                                <button class="btn btn-sm btn-outline-light" onclick="addToPlaylist('${song.id}')">Adicionar</button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        } catch (e) {
            console.error("Erro ao carregar m√∫sicas:", e);
        }
    }

    // 5. Fun√ß√£o de Tocar
    let currentTrackId = null;
    async function playTrack(id, title, artist) {
        document.getElementById('current-song-title').innerText = title;
        document.getElementById('current-artist').innerText = artist;
        try {
            const res = await fetch(`${API.BILLING}/status/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            if (!data.premium) {
                alert('Fa√ßa upgrade para tocar m√∫sicas.');
                return;
            }
        } catch (e) {}
        currentTrackId = id;
        const player = document.getElementById('audio-player');
        player.src = `${API.STREAM}/${id}`;
        await player.play();
        if (roomSocket) {
            const room = document.getElementById('room-id').value;
            roomSocket.send(JSON.stringify({ action: "play", room_id: room, timestamp: player.currentTime, track_id: currentTrackId }));
        }
    }
    async function ensureDefaultPlaylist() {
        let pid = localStorage.getItem('playlistId');
        if (pid) return pid;
        const listRes = await fetch(`${API.LIBRARY}/playlist/usuario/${userId}`);
        const listJson = await listRes.json();
        const exist = (listJson.dados || []).find(p => p && p.nome === 'Favoritos');
        if (exist) {
            localStorage.setItem('playlistId', exist.id);
            return exist.id;
        }
        const createRes = await fetch(`${API.LIBRARY}/playlist/criar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuarioId: userId, nome: 'Favoritos', descricao: 'Minhas favoritas' })
        });
        const createJson = await createRes.json();
        const newId = createJson.dados.id;
        localStorage.setItem('playlistId', newId);
        return newId;
    }
    async function addToPlaylist(musicaId) {
        try {
            const playlistId = await ensureDefaultPlaylist();
            await fetch(`${API.LIBRARY}/playlist/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ playlistId, musicaId })
            });
            alert('Adicionada √† playlist');
        } catch (e) {
            console.error(e);
            alert('Falha ao adicionar');
        }
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'login.html';
    }

    // Inicializa√ß√£o
    loadUserStatus();
    loadSongs();
    let roomSocket;
    let roomTimer;
    let roomTime = 0.0;
    let roomPlaying = false;
    const audioEl = document.getElementById('audio-player');
    audioEl.addEventListener('play', () => {
        if (roomSocket) {
            const room = document.getElementById('room-id').value;
            roomSocket.send(JSON.stringify({ action: "play", room_id: room, timestamp: audioEl.currentTime, track_id: currentTrackId }));
        }
    });
    audioEl.addEventListener('pause', () => {
        if (roomSocket) {
            const room = document.getElementById('room-id').value;
            roomSocket.send(JSON.stringify({ action: "pause", room_id: room, timestamp: audioEl.currentTime, track_id: currentTrackId }));
        }
    });
    function joinSala() {
        const user = username || 'An√¥nimo';
        const room = document.getElementById('room-id').value;
        roomSocket = new WebSocket("ws://localhost:3005/ws");
        roomSocket.onopen = () => {
            roomLog("Conectado");
            roomSocket.send(JSON.stringify({ action: "join", room_id: room, username: user }));
        };
        roomSocket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            processRoomMessage(msg);
        };
        roomSocket.onclose = () => {
            roomLog("Desconectado");
        };
    }
    function leaveSala() {
        if (roomSocket) {
            try { roomSocket.close(); } catch (e) {}
            roomSocket = null;
        }
        if (roomTimer) { clearInterval(roomTimer); roomTimer = null; }
        roomPlaying = false;
        document.getElementById('room-status').innerText = "Aguardando...";
        document.getElementById('room-status').className = "text-secondary";
        document.getElementById('room-votes').innerText = "Votos: 0/0";
        roomLog("Saiu da sala. Reprodu√ß√£o local.");
    }
    function processRoomMessage(msg) {
        if (msg.action === 'play' || msg.action === 'sync') {
            updateRoomPlayer(msg.timestamp, true);
            roomLog("Tocando em " + msg.timestamp.toFixed(1) + "s");
            if (msg.track_id && msg.track_id !== currentTrackId) {
                currentTrackId = msg.track_id;
                audioEl.src = `${API.STREAM}/${currentTrackId}`;
            }
            audioEl.currentTime = msg.timestamp;
            audioEl.play();
        } else if (msg.action === 'pause') {
            updateRoomPlayer(msg.timestamp, false);
            roomLog("Pausado em " + msg.timestamp.toFixed(1) + "s");
            if (msg.track_id && msg.track_id !== currentTrackId) {
                currentTrackId = msg.track_id;
                audioEl.src = `${API.STREAM}/${currentTrackId}`;
            }
            audioEl.currentTime = msg.timestamp;
            audioEl.pause();
        } else if (msg.action === 'chat') {
            addRoomChat(msg.username || 'An√¥nimo', msg.content);
        } else if (msg.action === 'vote_update') {
            document.getElementById('room-votes').innerText = msg.content;
            roomLog(msg.content);
        } else if (msg.action === 'skip_approved') {
            updateRoomPlayer(0, true);
            document.getElementById('room-votes').innerText = "Votos: 0/0";
            addRoomChat("SISTEMA", "M√∫sica pulada por vota√ß√£o");
            audioEl.currentTime = 0;
            audioEl.play();
        }
    }
    function sendRoomAction(action) {
        if (!roomSocket) return;
        const room = document.getElementById('room-id').value;
        roomSocket.send(JSON.stringify({ action: action, room_id: room, timestamp: roomTime }));
    }
    function sendRoomChat() {
        if (!roomSocket) return;
        const input = document.getElementById('room-chat-input');
        const text = input.value;
        const user = username || 'An√¥nimo';
        const room = document.getElementById('room-id').value;
        if (!text.trim()) return;
        roomSocket.send(JSON.stringify({ action: "chat", room_id: room, content: text, username: user }));
        input.value = "";
    }
    function updateRoomPlayer(timestamp, playing) {
        roomTime = timestamp;
        roomPlaying = playing;
        const statusDiv = document.getElementById('room-status');
        if (roomTimer) clearInterval(roomTimer);
        if (roomPlaying) {
            statusDiv.innerText = "Tocando";
            statusDiv.className = "text-success";
            roomTimer = setInterval(() => {
                roomTime += 0.1;
                document.getElementById('room-time').innerText = formatRoomTime(roomTime);
            }, 100);
        } else {
            statusDiv.innerText = "Pausado";
            statusDiv.className = "text-warning";
            document.getElementById('room-time').innerText = formatRoomTime(roomTime);
        }
    }
    function addRoomChat(user, text) {
        const chatBox = document.getElementById('room-chat');
        const div = document.createElement('div');
        div.innerHTML = "<strong>" + user + ":</strong> " + text;
        div.className = "mb-1";
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    function roomLog(text) {
        const logBox = document.getElementById('room-log');
        const div = document.createElement('div');
        div.innerText = "> " + text;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
    }
    function formatRoomTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return (m < 10 ? '0' : '') + m + ":" + (s < 10 ? '0' : '') + s;
    }
    function roomHandleEnter(e) { if (e.key === 'Enter') sendRoomChat(); }
</script>
</body>
</html>
